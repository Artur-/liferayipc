package com.vaadin.addon.ipcforliferay.demo.sender;

import java.io.IOException;
import java.util.UUID;

import com.vaadin.addon.ipcforliferay.LiferayIPC;
import com.vaadin.addon.ipcforliferay.demo.SessionAwarePortletApplication;
import com.vaadin.addon.ipcforliferay.demo.SessionAwarePortletApplication.TransferMode;
import com.vaadin.addon.ipcforliferay.demo.data.Person;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.ui.AbsoluteLayout;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.TextField;

/**
 * Demo form that supports sending Liferay client side inter-portlet messages to
 * other portlets on the same page.
 * 
 * Note that this portlet sends the message in two different ways at the same
 * time to demonstrate different ways to communicate complex data: as a
 * semicolon separated string via the client with the event id "newPerson", and
 * as a Person object in a shared portlet session with just a an internal
 * identifier for it sent via the client with the event id "newPersonInSession".
 * 
 * Normal applications only need one of these approaches.
 */
public class SenderView extends CustomComponent {

    @AutoGenerated
    private AbsoluteLayout mainLayout;
    @AutoGenerated
    private LiferayIPC liferayIPC_1;
    @AutoGenerated
    private TextField ageField;
    @AutoGenerated
    private TextField lastNameField;
    @AutoGenerated
    private TextField firstNameField;
    @AutoGenerated
    private Button button_1;

    /*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

    /**
     * The constructor should first build the main layout, set the composition
     * root and then do any custom initialization.
     * 
     * The constructor will not be automatically regenerated by the visual
     * editor.
     */
    public SenderView() {
        buildMainLayout();
        setCompositionRoot(mainLayout);

        button_1.addListener(new Button.ClickListener() {

            public void buttonClick(ClickEvent event) {
                // Send the form contents as a Liferay client side IPC message
                String firstName = (String) firstNameField.getValue();
                String lastName = (String) lastNameField.getValue();
                int age = Integer.parseInt((String) ageField.getValue());

                // Note: this portlet sends the same data in two different ways
                // for different receivers. Normally, only one approach would be
                // used in a portlet, and all receivers would listen to the same
                // channel.

                // simple way of sending all the data via the client
                sendPersonViaClient(firstName, lastName, age);

                // second way: put the person in a shared session attribute and
                // notify others via client-side IPC
                sendPersonViaSession(firstName, lastName, age);
            }
        });
    }

    /**
     * Send information about a person to other portlets as a suitably formatted
     * (semicolon separated) string using client-side IPC.
     * 
     * @param firstName
     * @param lastName
     * @param age
     */
    private void sendPersonViaClient(String firstName, String lastName, int age) {
        // format the message for easy parsing (semicolon separated)
        // no escaping of semicolons etc. is performed here
        liferayIPC_1.sendEvent("newPerson", firstName + ";" + lastName + ";"
                + age);
    }

    /**
     * Send information about a person to other portlets by putting the person
     * in a shared session attribute and then notifying other portlets of its
     * availability via client-side IPC without sending the actual data via the
     * client.
     * 
     * This requires the sending portlet to be configured for shared session
     * attributes (private-session-attributes must be false in
     * liferay-portlet.xml).
     * 
     * Note that this simple implementation does not clean up attributes added
     * to the session.
     * 
     * @param firstName
     * @param lastName
     * @param age
     */
    private void sendPersonViaSession(String firstName, String lastName, int age) {
        Person person = new Person(firstName, lastName, age);

        // generate a random key for the data to transfer
        String key = UUID.randomUUID().toString();

        // Put the person object in the session.
        // Note that between portlets in the same WAR, the
        // object could also be passed directly without
        // serializing it.
        try {
            getApplication().setSessionAttribute(
                    "LIFERAY_SHARED_vaadin_person_" + key, person,
                    TransferMode.BASE64);
        } catch (IOException e) {
            getWindow().showNotification(
                    "Storing a person in the portlet session failed");
            return;
        }

        // This only notifies listeners that a Person object has been
        // put or updated in the shared session. The message sent via the client
        // only contains an identifier with which the receiving portlets can
        // retrieve the data from the session.
        liferayIPC_1.sendEvent("newPersonInSession", key);
    }

    @Override
    public SessionAwarePortletApplication getApplication() {
        return (SessionAwarePortletApplication) super.getApplication();
    }

    @AutoGenerated
    private AbsoluteLayout buildMainLayout() {
        // common part: create layout
        mainLayout = new AbsoluteLayout();
        mainLayout.setWidth("180px");
        mainLayout.setHeight("180px");

        // top-level component properties
        setWidth("180px");
        setHeight("180px");

        // button_1
        button_1 = new Button();
        button_1.setCaption("Add");
        button_1.setImmediate(true);
        button_1.setWidth("-1px");
        button_1.setHeight("-1px");
        mainLayout.addComponent(button_1, "top:140.0px;left:20.0px;");

        // firstNameField
        firstNameField = new TextField();
        firstNameField.setCaption("First name");
        firstNameField.setImmediate(false);
        firstNameField.setWidth("-1px");
        firstNameField.setHeight("-1px");
        mainLayout.addComponent(firstNameField, "top:20.0px;left:20.0px;");

        // lastNameField
        lastNameField = new TextField();
        lastNameField.setCaption("Last name");
        lastNameField.setImmediate(false);
        lastNameField.setWidth("-1px");
        lastNameField.setHeight("-1px");
        mainLayout.addComponent(lastNameField, "top:61.0px;left:20.0px;");

        // ageField
        ageField = new TextField();
        ageField.setCaption("Age");
        ageField.setImmediate(false);
        ageField.setWidth("40px");
        ageField.setHeight("-1px");
        mainLayout.addComponent(ageField, "top:101.0px;left:20.0px;");

        // liferayIPC_1
        liferayIPC_1 = new LiferayIPC();
        liferayIPC_1.setImmediate(false);
        liferayIPC_1.setWidth("-1px");
        liferayIPC_1.setHeight("-1px");
        mainLayout.addComponent(liferayIPC_1, "top:138.0px;left:94.0px;");

        return mainLayout;
    }

}
